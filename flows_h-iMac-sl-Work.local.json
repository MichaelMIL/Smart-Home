[{"id":"f8a69929.e237e8","type":"tab","label":"Flow 1","disabled":false,"info":""},{"id":"2d5b237f.9a0b8c","type":"tab","label":"Master","disabled":true,"info":""},{"id":"9cafe56.8432418","type":"tab","label":"Washer","disabled":true,"info":""},{"id":"b61a4525.60fa38","type":"tab","label":"Lights","disabled":false,"info":""},{"id":"682235b0.7d7ffc","type":"tab","label":"Tasmota settings","disabled":false,"info":""},{"id":"7322a15a.c25b","type":"tab","label":"Flow 1","disabled":false,"info":""},{"id":"76b478db.f30ee8","type":"tab","label":"sunrise sunset","disabled":false,"info":""},{"id":"6211decf.abf95","type":"tab","label":"Dromi","disabled":false,"info":""},{"id":"4aa2421.1a66cbc","type":"tab","label":"Telegram","disabled":false,"info":""},{"id":"75e0ac27.40ea74","type":"tab","label":"Sofa_Light - Temp & humid","disabled":false,"info":""},{"id":"c8f16773.aebe28","type":"tab","label":"Whos Home","disabled":false,"info":""},{"id":"f70fb094.453b4","type":"tab","label":"Dud","disabled":false,"info":""},{"id":"c2b285fa.d5e928","type":"tab","label":"Logger","disabled":false,"info":""},{"id":"eb92f7bc.741d78","type":"mqtt-broker","z":"","name":"","broker":"localhost","port":"1883","clientid":"","usetls":false,"compatmode":false,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"572b96fc.c0b488","type":"ui_base","theme":{"name":"theme-dark","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"},"themeState":{"base-color":{"default":"#097479","value":"#097479","edited":false},"page-titlebar-backgroundColor":{"value":"#097479","edited":false},"page-backgroundColor":{"value":"#111111","edited":false},"page-sidebar-backgroundColor":{"value":"#000000","edited":false},"group-textColor":{"value":"#0eb8c0","edited":false},"group-borderColor":{"value":"#555555","edited":false},"group-backgroundColor":{"value":"#333333","edited":false},"widget-textColor":{"value":"#eeeeee","edited":false},"widget-backgroundColor":{"value":"#097479","edited":false},"widget-borderColor":{"value":"#333333","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey"}},"site":{"name":"Node-RED Dashboard","hideToolbar":"false","allowSwipe":"false","lockMenu":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":48,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"623367bd.b27df8","type":"ui_tab","z":"","name":"Home","icon":"dashboard","order":1,"disabled":false,"hidden":false},{"id":"497f9af9.8562b4","type":"ui_group","z":"","name":"Lights","tab":"623367bd.b27df8","order":1,"disp":true,"width":"6","collapse":false},{"id":"e9fce4c.97ada18","type":"ui_group","z":"","name":"Whether","tab":"623367bd.b27df8","order":2,"disp":true,"width":"6","collapse":false},{"id":"d60e4924.066e78","type":"ui_tab","z":"","name":"IoT info","icon":"dashboard","order":2,"disabled":false,"hidden":false},{"id":"d10bfab.f598b08","type":"ui_group","z":"","name":"Sofa_Light","tab":"d60e4924.066e78","order":1,"disp":true,"width":"6","collapse":false},{"id":"6db545d0.ad6a2c","type":"ui_tab","z":"","name":"Master","icon":"dashboard","order":3,"disabled":false,"hidden":false},{"id":"fb046245.c9a63","type":"ui_group","z":"","name":"Switches","tab":"6db545d0.ad6a2c","order":1,"disp":true,"width":"6","collapse":false},{"id":"c676c6a1.c8ddd8","type":"ui_spacer","name":"spacer","group":"d10bfab.f598b08","order":1,"width":6,"height":1},{"id":"7c410682.eb38c8","type":"telegrambot-config","z":"","botname":"Michaelmia_bot","usernames":"","chatIds":"725992047","pollInterval":"300"},{"id":"f930a286.154ea","type":"ui_tab","z":"","name":"Dud","icon":"dashboard","order":4,"disabled":false,"hidden":false},{"id":"115d9129.4791bf","type":"ui_group","z":"","name":"Dud","tab":"f930a286.154ea","order":1,"disp":true,"width":"6","collapse":false},{"id":"a5259a9a.ec9468","type":"mqtt out","z":"2d5b237f.9a0b8c","name":"Master Light Out","topic":"cmnd/Lights/power","qos":"","retain":"","broker":"eb92f7bc.741d78","x":910,"y":80,"wires":[]},{"id":"6d47a1b3.12988","type":"comment","z":"2d5b237f.9a0b8c","name":"Master functions","info":"Sends MQTT message :\"off\" from MasterLightOut","x":700,"y":40,"wires":[]},{"id":"89f98683.adb978","type":"mqtt in","z":"2d5b237f.9a0b8c","name":"Kill reciver","topic":"Master/reciver","qos":"2","datatype":"auto","broker":"eb92f7bc.741d78","x":680,"y":200,"wires":[[]]},{"id":"63299f0f.cc6ae","type":"comment","z":"2d5b237f.9a0b8c","name":"Pause Spotify when turning off reciver","info":"","x":790,"y":140,"wires":[]},{"id":"199d33e7.8120fc","type":"exec","z":"2d5b237f.9a0b8c","command":"echo 'standby 5' | cec-client -s -d 1","addpay":false,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"reciverOff","x":860,"y":440,"wires":[[],[],[]]},{"id":"81e10ff7.295b7","type":"exec","z":"2d5b237f.9a0b8c","command":"echo 'on 5' | cec-client -s -d 1","addpay":false,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"reciverOn","x":860,"y":380,"wires":[[],[],[]]},{"id":"2b15336.97951cc","type":"exec","z":"2d5b237f.9a0b8c","command":"echo 'as' | cec-client -s -d 1","addpay":false,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"CangeToSPOTIFY","x":890,"y":320,"wires":[[],[],[]]},{"id":"cbde1091.503de","type":"comment","z":"2d5b237f.9a0b8c","name":"Use cec-client commands to control HDMI","info":"echo 'on 5' | cec-client -s -d 1","x":780,"y":260,"wires":[]},{"id":"c74c38b.2b548c8","type":"mqtt in","z":"2d5b237f.9a0b8c","name":"Kill reciver","topic":"Master/reciver","qos":"2","datatype":"auto","broker":"eb92f7bc.741d78","x":490,"y":440,"wires":[["d3921310.f19f3"]]},{"id":"9cc332b7.3641c","type":"mqtt in","z":"9cafe56.8432418","name":"","topic":"Whashing","qos":"2","datatype":"auto","broker":"eb92f7bc.741d78","x":160,"y":120,"wires":[["72fee9c5.1fa218","30f7bfbe.632fd"]]},{"id":"72fee9c5.1fa218","type":"function","z":"9cafe56.8432418","name":"Boot notification","func":"if (msg.payload == \"start\"){\nmsg.payload ={};\nmsg.payload.chatId = 725992047;\nmsg.payload.type = \"message\";\nvar date = new Date().toLocaleString(\"en-GB\", {timeZone: \"Asia/Jerusalem\"});\nmsg.payload.content =\"Whshing Set on: \" + date;\nreturn msg;\n    \n}\nif (msg.payload == \"stop\"){\nmsg.payload ={};\nmsg.payload.chatId = 725992047;\nmsg.payload.type = \"message\";\ndate = new Date().toLocaleString(\"en-GB\", {timeZone: \"Asia/Jerusalem\"});\nmsg.payload.content =\"Whshing Finished on: \" + date;\nreturn msg;\n    \n}\n\n","outputs":1,"noerr":0,"x":400,"y":120,"wires":[["95995faf.8ab85","36484529.d533fa"]]},{"id":"30f7bfbe.632fd","type":"debug","z":"9cafe56.8432418","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":500,"y":220,"wires":[]},{"id":"95995faf.8ab85","type":"debug","z":"9cafe56.8432418","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":520,"y":180,"wires":[]},{"id":"873b4245.24a64","type":"mqtt in","z":"682235b0.7d7ffc","name":"","topic":"stat/Sofa_Light/#","qos":"0","datatype":"auto","broker":"eb92f7bc.741d78","x":120,"y":120,"wires":[["251b1d2.e81e9e2"]]},{"id":"1fea821b.71427e","type":"mqtt out","z":"682235b0.7d7ffc","name":"","topic":"cmnd/Lights/power","qos":"0","retain":"","broker":"eb92f7bc.741d78","x":350,"y":340,"wires":[]},{"id":"a3ca7676.942a08","type":"inject","z":"682235b0.7d7ffc","name":"","topic":"","payload":"off","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":"","x":130,"y":340,"wires":[["1fea821b.71427e"]]},{"id":"12195d5d.61d4b3","type":"inject","z":"682235b0.7d7ffc","name":"","topic":"","payload":"on","payloadType":"str","repeat":"","crontab":"","once":false,"x":130,"y":380,"wires":[["1fea821b.71427e"]]},{"id":"cf7de4fd.8db088","type":"inject","z":"682235b0.7d7ffc","name":"","topic":"","payload":"toggle","payloadType":"str","repeat":"","crontab":"","once":false,"x":130,"y":420,"wires":[["1fea821b.71427e"]]},{"id":"89303ac.e7160c8","type":"comment","z":"682235b0.7d7ffc","name":"Subscribe to all messages","info":"This is just to subscribe to all messages \ncoming from ESPurna. You can turn this off\nonce you are completed the setup.\n\nHere I put the same topic ID as what I entered\non the UI and # at the end.","x":110,"y":80,"wires":[]},{"id":"e910f93.f085508","type":"comment","z":"682235b0.7d7ffc","name":"MQTT control","info":"Controlling the relay via MQTT\n\nroot topic followed by relay/0/set\naccepted messages:\n0: off\n1: on\n2: toggle","x":90,"y":300,"wires":[]},{"id":"c9b73f9f.a0aa","type":"mqtt out","z":"682235b0.7d7ffc","name":"","topic":"cmnd/Sofa_Light/status","qos":"0","retain":"","broker":"eb92f7bc.741d78","x":350,"y":240,"wires":[]},{"id":"b86ca4fe.dd81f8","type":"inject","z":"682235b0.7d7ffc","name":"","topic":"","payload":"0","payloadType":"num","repeat":"3600","crontab":"","once":true,"onceDelay":"0.3","x":110,"y":240,"wires":[["c9b73f9f.a0aa"]]},{"id":"52c85846.d52f68","type":"json","z":"682235b0.7d7ffc","name":"","property":"payload","action":"","pretty":false,"x":510,"y":100,"wires":[["60672eba.bed03"]]},{"id":"251b1d2.e81e9e2","type":"switch","z":"682235b0.7d7ffc","name":"JSON format?","property":"$substring(msg.payload, 0, 1)=\"{\"","propertyType":"jsonata","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":320,"y":120,"wires":[["52c85846.d52f68"],["60672eba.bed03"]]},{"id":"32a502c5.46e12e","type":"mqtt in","z":"682235b0.7d7ffc","name":"","topic":"tele/Sofa_Light/#","qos":"0","datatype":"auto","broker":"eb92f7bc.741d78","x":120,"y":180,"wires":[["251b1d2.e81e9e2","60672eba.bed03"]]},{"id":"58d368d0.f6b3f8","type":"function","z":"682235b0.7d7ffc","name":"Store last update","func":"var devicename = \"Sofa_Light\";\n\nvar temp = global.get(devicename+\"_wifi\");\nvar current = new Date();\nif (temp!== undefined && temp!==null) {\n    msg.payload = current.getTime() - temp;\n    global.set(devicename+\"_wifi\",current.getTime());\n} else {\n    msg.payload = \"\";\n    global.set(devicename+\"_wifi\",current.getTime());\n}\n\n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});\n\nmsg.formattedtime = dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss;\n\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":600,"wires":[[]]},{"id":"83cfcc5.8d0af3","type":"inject","z":"682235b0.7d7ffc","name":"","topic":"","payload":"","payloadType":"date","repeat":"1","crontab":"","once":false,"x":150,"y":680,"wires":[["aa169bf6.483888"]]},{"id":"aa169bf6.483888","type":"function","z":"682235b0.7d7ffc","name":"From last update","func":"var devicename = \"Sofa_Light\";\n\nvar temp = global.get(devicename+\"_wifi\");\nvar current = new Date();\nmsg.payload = \"No data\";\nmsg.warning = false;\n\nif (temp!==undefined) {\n    current = current - temp;\n    current = Math.floor(current/1000);\n    var minute = Math.floor(current/60);\n    var hour = Math.floor(minute/60);\n    var day = Math.floor(hour/24);\n    if (current>24*60*60) {\n        msg.payload = \"Last update \" + day + \" days, \" + hour%24 + \" hours, \" + minute%60 + \" minutes, \" + current%60 + \" seconds ago\";\n    } else if (current>60*60) {\n        msg.payload = \"Last update \" + hour%24 + \" hours, \" + minute%60 + \" minutes, \" + current%60 + \" seconds ago\";\n    } else if (current>60) {\n        msg.payload = \"Last update \" + minute%60 + \" minutes, \" + current%60 + \" seconds ago\";\n    } else {\n        msg.payload = \"Last update \" + current%60 + \" seconds ago\";\n    }\n\n}\n\nnode.status({fill:\"blue\",shape:\"ring\",text:msg.payload});\n\n\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":680,"wires":[["1071e287.e084ad"]]},{"id":"f19c22a7.7a8d3","type":"json","z":"682235b0.7d7ffc","name":"","property":"payload","action":"","pretty":false,"x":330,"y":520,"wires":[["58d368d0.f6b3f8","ccf4892f.2f4678","8de1a9e1.b7d388"]]},{"id":"ccf4892f.2f4678","type":"change","z":"682235b0.7d7ffc","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.StatusSTS.Wifi.RSSI","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":500,"y":560,"wires":[["3396cbe8.d3dee4"]]},{"id":"60672eba.bed03","type":"debug","z":"682235b0.7d7ffc","d":true,"name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":680,"y":160,"wires":[]},{"id":"1d246364.5200dd","type":"mqtt in","z":"682235b0.7d7ffc","name":"","topic":"stat/Sofa_Light/STATUS11","qos":"0","datatype":"auto","broker":"eb92f7bc.741d78","x":150,"y":520,"wires":[["f19c22a7.7a8d3"]]},{"id":"8de1a9e1.b7d388","type":"function","z":"682235b0.7d7ffc","name":"Up time ","func":"var date = new Date(null);\ndate.setSeconds(msg.payload.StatusSTS.UptimeSec); // specify value for SECONDS here\nvar timeString = date.toISOString().substr(11, 8);\nmsg.payload = timeString;\nreturn msg;","outputs":1,"noerr":0,"x":490,"y":520,"wires":[["809ba37c.b2af6"]]},{"id":"13f4f24.f45c70e","type":"mqtt in","z":"b61a4525.60fa38","name":"","topic":"stat/Sofa_Light/RESULT","qos":"2","datatype":"auto","broker":"eb92f7bc.741d78","x":130,"y":200,"wires":[["2292f55d.7618ea"]]},{"id":"2292f55d.7618ea","type":"json","z":"b61a4525.60fa38","name":"","property":"payload","action":"","pretty":false,"x":290,"y":200,"wires":[["8dc9055d.3b94e8"]]},{"id":"8dc9055d.3b94e8","type":"function","z":"b61a4525.60fa38","name":"ON/OFF -> True/False","func":"if (msg.payload.POWER == \"OFF\") msg.payload = false;\nif (msg.payload.POWER == \"ON\") msg.payload = true;\nreturn msg;","outputs":1,"noerr":0,"x":460,"y":180,"wires":[["7a047427.d9d90c","121d6c46.f39a54"]]},{"id":"65901f96.31e01","type":"inject","z":"682235b0.7d7ffc","name":"","topic":"","payload":"check Relay status","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":150,"y":460,"wires":[["1fea821b.71427e"]]},{"id":"8db504cc.4b1f58","type":"mqtt in","z":"7322a15a.c25b","name":"","topic":"stat/#","qos":"2","datatype":"auto","broker":"eb92f7bc.741d78","x":110,"y":100,"wires":[["f7e1463f.907158"]]},{"id":"f7e1463f.907158","type":"function","z":"7322a15a.c25b","name":"","func":"\nif (msg.topic.includes(\"POWER\")){\n    var state;\n    if (msg.payload == \"OFF\") {\n        state = \"ðŸ…¾ï¸\";\n        node.status({fill:\"red\",shape:\"ring\",text:(\"Light is: OFF\")});\n    }\n    if (msg.payload == \"ON\"){\n            state = \"âœ…\";\n            node.status({fill:\"green\",shape:\"dot\",text:(\"Light is: ON\")});\n    }\n    msg.payload = {};\n    msg.payload.chatId = 725992047;\n    msg.payload.type = \"message\";\n    var topic = msg.topic.split(\"/\");\n    var device = topic[1];\n    msg.payload.content = (\"Device: \" + device + \", Status: \" + state);\n    msg1={};\n    msg1.payload = \"stop\";\n    \n    return [[msg,msg1]];\n}\nelse return null;\n\n\n\n","outputs":1,"noerr":0,"x":250,"y":100,"wires":[["d9ad7a18.ad0948"]]},{"id":"2927eca7.bdfe94","type":"function","z":"7322a15a.c25b","name":"","func":"if (msg.payload){\n    msg.topic = \"cmnd/Lights/power\";\n    msg.payload = \"check\";\n    \n    \n    msg1 = {};\n    msg1.topic = \"triger\";\n    msg1.payload = \"allow\";\n    return [msg, msg1];\n}\n","outputs":2,"noerr":0,"x":270,"y":160,"wires":[["eeb2fe60.f9c42"],["d9ad7a18.ad0948"]]},{"id":"eeb2fe60.f9c42","type":"mqtt out","z":"7322a15a.c25b","name":"","topic":"","qos":"0","retain":"","broker":"eb92f7bc.741d78","x":450,"y":160,"wires":[]},{"id":"3396cbe8.d3dee4","type":"function","z":"682235b0.7d7ffc","name":"","func":"if (msg.topic == \"init\"){\n    context.set('wifi_signal', 0);\n}\nif(msg.topic == \"stat/Sofa_Light/STATUS11\"){\n    context.set('wifi_signal', msg.payload);\n}\nmsg.payload = context.get('wifi_signal');\nnode.status({fill:\"blue\",shape:\"ring\",text:(\"Wifi Signal: \"+msg.payload)});\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":560,"wires":[["65ee9fb9.528d2"]]},{"id":"8b88c6ad.cdb2a8","type":"inject","z":"682235b0.7d7ffc","name":"","topic":"","payload":"true","payloadType":"bool","repeat":"5","crontab":"","once":false,"onceDelay":0.1,"x":330,"y":560,"wires":[["3396cbe8.d3dee4"]]},{"id":"c629f4fc.a92128","type":"inject","z":"76b478db.f30ee8","name":"","topic":"","payload":"","payloadType":"date","repeat":"10800","crontab":"","once":true,"onceDelay":"0.2","x":130,"y":80,"wires":[["4b74be0e.5fe0b"]]},{"id":"4b74be0e.5fe0b","type":"http request","z":"76b478db.f30ee8","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"https://api.darksky.net/forecast/fb94b21247b7b6fb77864d817144fca7/32.434048,34.919651?units=si&exclude=hourly,flags","tls":"","persist":false,"proxy":"","authType":"","x":220,"y":140,"wires":[["6c1987c3.1cfd88"]]},{"id":"6c1987c3.1cfd88","type":"json","z":"76b478db.f30ee8","name":"","property":"payload","action":"","pretty":false,"x":370,"y":140,"wires":[["b64436fe.14adb8"]]},{"id":"a57ae304.8a17e","type":"function","z":"76b478db.f30ee8","name":"Set Sunrise/Sunset","func":"if (msg.topic == \"init\"){\n    context.set(['sunrise', 'sunset'], [null , null]);\n}\nif (msg.topic == \"forcast\"){\n    context.set('sunset', msg.payload.daily.data[0].sunsetTime);\n    context.set('sunrise', msg.payload.daily.data[0].sunriseTime);\n}\nelse {\n    var sunrise =new Date(null);\n    sunrise.setSeconds(context.get(\"sunrise\"));\n    msg.topic = sunrise.toLocaleTimeString().substr(0, 5);\n    var sunset = new Date(null);\n    sunset.setSeconds(context.get(\"sunset\"));\n    msg.payload = sunset.toLocaleTimeString().substr(0, 5);\n    return msg;\n    \n}\n","outputs":1,"noerr":0,"x":530,"y":320,"wires":[["db4c7753.aafe58","62fe89e4.c60248"]]},{"id":"6ddbc94a.03b658","type":"inject","z":"76b478db.f30ee8","name":"","topic":"init","payload":"true","payloadType":"bool","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":380,"y":360,"wires":[["a57ae304.8a17e"]]},{"id":"b64436fe.14adb8","type":"change","z":"76b478db.f30ee8","name":"","rules":[{"t":"set","p":"topic","pt":"msg","to":"forcast","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":540,"y":120,"wires":[["a57ae304.8a17e","d05037a7.009028"]]},{"id":"b57c70de.1248a","type":"inject","z":"76b478db.f30ee8","name":"","topic":"","payload":"","payloadType":"date","repeat":"1","crontab":"","once":true,"onceDelay":"0.2","x":250,"y":320,"wires":[["a57ae304.8a17e"]]},{"id":"d05037a7.009028","type":"debug","z":"76b478db.f30ee8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":560,"y":220,"wires":[]},{"id":"8aa7d7df.8c9c28","type":"inject","z":"6211decf.abf95","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":260,"y":160,"wires":[["1d7cdd19.9ff013"]]},{"id":"be9d2dc9.1724a","type":"http request","z":"6211decf.abf95","name":"","method":"GET","ret":"txt","paytoqs":true,"url":"http://magicseaweed.com/api/9f0bffaa408d046b00b41da0ce4244bd/forecast/?spot_id=4744&units=uk&localTimestamp={{query}}","tls":"","persist":false,"proxy":"","authType":"","x":590,"y":160,"wires":[["2fbf0e37.dc1d12"]]},{"id":"2fbf0e37.dc1d12","type":"json","z":"6211decf.abf95","name":"","property":"payload","action":"","pretty":false,"x":230,"y":280,"wires":[["196b137f.b4606d"]]},{"id":"1d7cdd19.9ff013","type":"change","z":"6211decf.abf95","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"query","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":420,"y":160,"wires":[["be9d2dc9.1724a"]]},{"id":"d1899bc6.c31978","type":"ui_button","z":"2d5b237f.9a0b8c","name":"turnOffAllLights","group":"d10bfab.f598b08","order":1,"width":6,"height":1,"passthru":true,"label":"Kill lights","tooltip":"","color":"","bgcolor":"","icon":"","payload":"0","payloadType":"str","topic":"","x":700,"y":80,"wires":[["a5259a9a.ec9468"]]},{"id":"da9d102c.f5c46","type":"ui_button","z":"2d5b237f.9a0b8c","name":"ChangeToSpotify","group":"d10bfab.f598b08","order":1,"width":6,"height":1,"passthru":false,"label":"Change To Spotify","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"","x":690,"y":320,"wires":[["2b15336.97951cc"]]},{"id":"6fd798ca.165598","type":"ui_button","z":"2d5b237f.9a0b8c","name":"reciverOn","group":"d10bfab.f598b08","order":2,"width":6,"height":1,"passthru":false,"label":"Reciver On","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"","x":660,"y":380,"wires":[["81e10ff7.295b7"]]},{"id":"d3921310.f19f3","type":"ui_button","z":"2d5b237f.9a0b8c","name":"reciverOff","group":"d10bfab.f598b08","order":3,"width":6,"height":1,"passthru":true,"label":"reciver Off","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"","x":660,"y":440,"wires":[["199d33e7.8120fc"]]},{"id":"809ba37c.b2af6","type":"ui_text","z":"682235b0.7d7ffc","group":"d10bfab.f598b08","order":3,"width":0,"height":0,"name":"","label":"Uptime","format":"{{msg.payload}}","layout":"row-spread","x":640,"y":520,"wires":[]},{"id":"1071e287.e084ad","type":"ui_text","z":"682235b0.7d7ffc","group":"d10bfab.f598b08","order":4,"width":0,"height":0,"name":"Last Update","label":"","format":"{{msg.payload}}","layout":"row-spread","x":550,"y":680,"wires":[]},{"id":"62fe89e4.c60248","type":"ui_text","z":"76b478db.f30ee8","group":"e9fce4c.97ada18","order":2,"width":3,"height":1,"name":"Sunset","label":"","format":"Sunset: {{msg.payload}}","layout":"row-left","x":700,"y":340,"wires":[]},{"id":"db4c7753.aafe58","type":"ui_text","z":"76b478db.f30ee8","group":"e9fce4c.97ada18","order":1,"width":3,"height":1,"name":"Sunrise","label":"","format":"Sunrise: {{msg.topic}}","layout":"row-left","x":700,"y":281,"wires":[]},{"id":"65ee9fb9.528d2","type":"ui_gauge","z":"682235b0.7d7ffc","name":"Wifi gauge","group":"d10bfab.f598b08","order":2,"width":0,"height":0,"gtype":"gage","title":"Signal","label":"","format":"{{value}}","min":"0","max":"100","colors":["#ff0000","#e6e600","#00b500"],"seg1":"","seg2":"","x":790,"y":560,"wires":[]},{"id":"b000d41d.94c698","type":"Tasmota Switch","z":"b61a4525.60fa38","broker":"eb92f7bc.741d78","device":"Sofa_Light","name":"","outputs":1,"fullTopic":"","cmndPrefix":"","statPrefix":"","telePrefix":"","x":390,"y":120,"wires":[["7a047427.d9d90c"]]},{"id":"d9ad7a18.ad0948","type":"traffic","z":"7322a15a.c25b","name":"","property_allow":"payload","filter_allow":"allow","ignore_case_allow":false,"negate_allow":false,"send_allow":false,"property_stop":"payload","filter_stop":"stop","ignore_case_stop":true,"negate_stop":false,"send_stop":false,"default_start":false,"differ":false,"x":430,"y":100,"wires":[["39380685.9e9b9a"]]},{"id":"7a047427.d9d90c","type":"ui_led","z":"b61a4525.60fa38","group":"497f9af9.8562b4","order":1,"width":1,"height":1,"label":"","labelPlacement":"left","labelAlignment":"left","colorForValue":[{"color":"red","value":"false","valueType":"bool"},{"color":"green","value":"true","valueType":"bool"}],"allowColorForValueInMessage":false,"name":"","x":610,"y":120,"wires":[]},{"id":"767e99ac.390e18","type":"telegrambot-switch","z":"4aa2421.1a66cbc","name":"Room","bot":"7c410682.eb38c8","chatId":"725992047","question":"Smart Home","answers":["Liiving Room =>","Kitchen =>","Dud =>","info","Back"],"outputs":5,"autoAnswerCallback":true,"timeoutValue":"","timeoutUnits":"","x":130,"y":300,"wires":[["64c56e44.dd6c"],["a522e996.100fd8"],["e61ff2c0.5b816"],["a2e0993f.7229c8","c15c3212.3220c"],["998ce581.e796e8"]]},{"id":"8c3efb00.fbe258","type":"telegrambot-switch","z":"4aa2421.1a66cbc","name":"Device:","bot":"7c410682.eb38c8","chatId":"725992047","question":"Device?","answers":["Lights =>","Sockets =>","Back"],"outputs":3,"autoAnswerCallback":true,"timeoutValue":"","timeoutUnits":"","x":460,"y":240,"wires":[["6932d3e2.dd8cbc"],["40985d82.f8d444"],["bb70e7b0.ba70f8"]]},{"id":"e3c6bc33.29807","type":"telegrambot-switch","z":"4aa2421.1a66cbc","name":"Set Lights","bot":"7c410682.eb38c8","chatId":"725992047","question":"ON/OFF","answers":["Sofa=>âœ…","Sofa=> ðŸ…¾ï¸","Back"],"outputs":3,"autoAnswerCallback":true,"timeoutValue":"","timeoutUnits":"","x":360,"y":720,"wires":[["f0a93b4a.b4ced8"],["ede25d26.9f582"],["103a33b4.152b9c"]]},{"id":"a522e996.100fd8","type":"change","z":"4aa2421.1a66cbc","name":"kitchen","rules":[{"t":"set","p":"topic","pt":"msg","to":"kitchen","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":280,"y":240,"wires":[["8c3efb00.fbe258"]]},{"id":"64c56e44.dd6c","type":"change","z":"4aa2421.1a66cbc","name":"Living Room","rules":[{"t":"set","p":"topic","pt":"msg","to":"livingRoom","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":290,"y":200,"wires":[["8c3efb00.fbe258"]]},{"id":"333985e6.898c2a","type":"change","z":"4aa2421.1a66cbc","name":"topic=>lights","rules":[{"t":"set","p":"topic","pt":"msg","to":"Lights","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":210,"y":720,"wires":[["e3c6bc33.29807"]]},{"id":"79989e5d.4f237","type":"change","z":"4aa2421.1a66cbc","name":"topic->socket","rules":[{"t":"set","p":"topic","pt":"msg","to":"Sockets","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":240,"y":800,"wires":[["7730a5b2.247bdc"]]},{"id":"4d872c0e.fe9ec4","type":"link out","z":"4aa2421.1a66cbc","name":"Lights out","links":["6ee1d2b6.8e141c"],"x":735,"y":180,"wires":[]},{"id":"6ee1d2b6.8e141c","type":"link in","z":"4aa2421.1a66cbc","name":"lights in","links":["4d872c0e.fe9ec4"],"x":115,"y":720,"wires":[["333985e6.898c2a"]]},{"id":"ef657998.17c798","type":"link in","z":"4aa2421.1a66cbc","name":"kitchen in","links":["40985d82.f8d444","349a0ed8.8cd542"],"x":115,"y":800,"wires":[["79989e5d.4f237"]]},{"id":"40985d82.f8d444","type":"link out","z":"4aa2421.1a66cbc","name":"","links":["ef657998.17c798"],"x":587,"y":233,"wires":[]},{"id":"7730a5b2.247bdc","type":"telegrambot-notify","z":"4aa2421.1a66cbc","name":"","bot":"7c410682.eb38c8","chatId":"725992047","message":"Under Constructionâ€¼ï¸âš ï¸        /SmartHome","parseMode":"","x":420,"y":800,"wires":[]},{"id":"dbf669d8.e11dd8","type":"link in","z":"b61a4525.60fa38","name":"","links":["8e0dc446.08af28","c395e44a.84b2c8"],"x":235,"y":120,"wires":[["b000d41d.94c698"]]},{"id":"8e0dc446.08af28","type":"link out","z":"4aa2421.1a66cbc","name":"T.ON/OFF","links":["dbf669d8.e11dd8","9e7e6ef0.2bcc2"],"x":695,"y":680,"wires":[]},{"id":"f0a93b4a.b4ced8","type":"change","z":"4aa2421.1a66cbc","name":"Sofa -ON","rules":[{"t":"set","p":"payload","pt":"msg","to":"ON","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":560,"y":680,"wires":[["8e0dc446.08af28"]]},{"id":"ede25d26.9f582","type":"change","z":"4aa2421.1a66cbc","name":"Sofa - OFF","rules":[{"t":"set","p":"payload","pt":"msg","to":"OFF","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":570,"y":720,"wires":[["8e0dc446.08af28"]]},{"id":"4dd93ea1.d6d36","type":"function","z":"4aa2421.1a66cbc","name":"Boot-Up","func":"msg.method = \"sendMessage\";\nvar date = new Date().toLocaleString(\"en-GB\", {timeZone: \"Asia/Jerusalem\"});\nmsg.payload =\"System Booted On: \" + date+\"\\n /SmartHome :)\";\n\nreturn msg;\n","outputs":1,"noerr":0,"x":280,"y":40,"wires":[["9decc1f9.2ef85"]]},{"id":"2c53bd19.a4c962","type":"inject","z":"4aa2421.1a66cbc","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":"2","x":130,"y":40,"wires":[["4dd93ea1.d6d36"]]},{"id":"9decc1f9.2ef85","type":"telegrambot-notify","z":"4aa2421.1a66cbc","name":"","bot":"7c410682.eb38c8","chatId":"725992047","message":"","parseMode":"","x":460,"y":40,"wires":[]},{"id":"b3a08604.8ba3a8","type":"telegrambot-command","z":"4aa2421.1a66cbc","name":"start","bot":"7c410682.eb38c8","command":"/SmartHome","commandType":"str","commandCase":false,"x":70,"y":120,"wires":[["bab6ed2a.3ac4c"]]},{"id":"bab6ed2a.3ac4c","type":"telegrambot-switch","z":"4aa2421.1a66cbc","name":"Home","bot":"7c410682.eb38c8","chatId":"725992047","question":"hello","answers":["Home","Dromi","info"],"outputs":3,"autoAnswerCallback":true,"timeoutValue":"","timeoutUnits":"","x":210,"y":120,"wires":[["3fc591fd.e880fe"],["4381f2da.937c4c"],["f42f8ffa.7f915"]]},{"id":"f42f8ffa.7f915","type":"telegrambot-switch","z":"4aa2421.1a66cbc","name":"info","bot":"7c410682.eb38c8","chatId":"725992047","question":"What Would You Like To Do?","answers":["Check for light status","kill all lights","Back"],"outputs":3,"autoAnswerCallback":true,"timeoutValue":"","timeoutUnits":"","x":410,"y":120,"wires":[["f32a017b.735fb"],["39a0e67e.11359a"],["96858f1.695be7"]]},{"id":"f32a017b.735fb","type":"function","z":"4aa2421.1a66cbc","name":"check","func":"\nmsg.payload = \"/STS\";\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":100,"wires":[["575487e8.3672b8"]]},{"id":"39a0e67e.11359a","type":"function","z":"4aa2421.1a66cbc","name":"kill lights","func":"msg.topic = \"cmnd/Lights/power\";\nmsg.payload = \"0\";\nreturn msg;","outputs":1,"noerr":0,"x":620,"y":140,"wires":[["e6f9e258.ffc64","575487e8.3672b8"]]},{"id":"e6f9e258.ffc64","type":"mqtt out","z":"4aa2421.1a66cbc","name":"","topic":"","qos":"","retain":"","broker":"eb92f7bc.741d78","x":750,"y":140,"wires":[]},{"id":"9daa3086.490c3","type":"telegrambot-notify","z":"7322a15a.c25b","name":"","bot":"7c410682.eb38c8","chatId":"725992047","message":"","parseMode":"","x":760,"y":100,"wires":[]},{"id":"39380685.9e9b9a","type":"function","z":"7322a15a.c25b","name":"","func":"if (msg.topic == \"stat/Sofa_Light/POWER\"){\n    msg.payload = msg.payload.content+\"\\n/SmartHome\";\n    return msg;\n}\nelse return null;\n","outputs":1,"noerr":0,"x":590,"y":100,"wires":[["9daa3086.490c3"]]},{"id":"575487e8.3672b8","type":"link out","z":"4aa2421.1a66cbc","name":"check light out","links":["11b9fd00.98db73"],"x":735,"y":100,"wires":[]},{"id":"11b9fd00.98db73","type":"link in","z":"7322a15a.c25b","name":"check light in","links":["575487e8.3672b8"],"x":120,"y":160,"wires":[["2927eca7.bdfe94"]]},{"id":"6f995453.787f1c","type":"inject","z":"75e0ac27.40ea74","name":"","topic":"","payload":"stat","payloadType":"str","repeat":"60","crontab":"","once":true,"onceDelay":0.1,"x":130,"y":80,"wires":[["4ed3caf.564ae34","76211210.8cea4c"]]},{"id":"76211210.8cea4c","type":"mqtt out","z":"75e0ac27.40ea74","name":"","topic":"cmnd/Sofa_Light/power","qos":"","retain":"","broker":"eb92f7bc.741d78","x":370,"y":200,"wires":[]},{"id":"d6a9019e.4bed3","type":"function","z":"75e0ac27.40ea74","name":"last 24 hours","func":"var temp_humid_array_size = 1440;\n\nif (msg.topic == \"init\"){\n   global.set(['counter','time','temperature','humidity'],[0,[],[],[]]); \n}\n\nif (msg.payload.AM2301.Temperature){\n    var i = global.get('counter');\n    \n    global.set(\"time[\"+i+\"]\", new Date().getTime());\n    global.set(\"temperature[\"+i+\"]\", msg.payload.AM2301.Temperature);\n    global.set(\"humidity[\"+i+\"]\", msg.payload.AM2301.Humidity);\n    i++;\n    global.set(\"counter\", i);\n    if (i>temp_humid_array_size) global.set(['counter','time','temperature','humidity'],[0,[],[],[]]); \n    }\n\nnode.status({fill:\"grey\",shape:\"ring\",text:(\"Counter on: \" + global.get('counter'))});\n\n\nvar htlog = {\n    name: \"htlog\",\n    time: null,\n    temp: null,\n    hum: null\n};\nhtlog.time = Date.now();\nhtlog.temp= msg.payload.AM2301.Temperature;\nhtlog.hum= msg.payload.AM2301.Humidity;\nmsg = htlog;\nmsg.name = \"htLog\"\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":100,"wires":[["d0dee4b9.c02d58"]]},{"id":"e63f528d.87e39","type":"function","z":"75e0ac27.40ea74","name":"Data for chart","func":"    var tt = global.get ('time');\n    var flag = 1;\n    var count = 0;\n    for (var u = 0; u <tt.length;u++ ){\n    if (u){\n        if (global.get(\"time[\"+u+\"]\")<global.get(\"time[\"+(u-1)+\"]\")){\n            var tempr = global.get(\"time[\"+u+\"]\");\n            var tempt = global.get(\"temperature[\"+u+\"]\");\n            var humm =global.get(\"humidity[\"+u+\"]\");\n            global.set(\"time[\"+u+\"]\", global.get(\"time[\"+(u-1)+\"]\"));\n            global.set(\"time[\"+(u-1)+\"]\", tempr);\n            global.set(\"temperature[\"+u+\"]\", global.get(\"temperature[\"+(u-1)+\"]\"));\n            global.set(\"temperature[\"+(u-1)+\"]\", tempt);\n            global.set(\"humidity[\"+u+\"]\", global.get(\"humidity[\"+(u-1)+\"]\"));\n            global.set(\"humidity[\"+u+\"]\", humm);\n            flag = true;\n            count = 0;\n        }\n        if (u == (tt.length-1)) u=0;\n        if (flag === 0 && count>=tt.length) break;\n        else {\n            flag =0 ;\n            count++;\n        }\n        \n    }\n}\n\n\nvar data = [];\ndata[0]=[];\ndata[1]=[];\nfor (var i = 0; i<tt.length; i++ ){\n    var time = global.get(\"time[\"+i+\"]\");\n    var temp = global.get(\"temperature[\"+i+\"]\");\n    var hum = global.get (\"humidity[\"+i+\"]\");\n    data[0].push({x: time, y: temp});\n    data[1].push({x: time, y: hum});\n    \n    \n}\nvar chart = [{\n\"series\": [\"Temperature\", \"Humidity\"],\n\"data\": \n    data,\n\"labels\": [\"Temperature\", \"Humidity\"]\n}]\nmsg.payload = chart;\nvar last_temp = global.get(\"temperature[\"+(tt.length-1)+\"]\");\nvar last_hum = global.get(\"humidity[\"+(tt.length-1)+\"]\");\nnode.status({fill:\"blue\",shape:\"dot\",text:(\"Temp is: \" + last_temp + \" Hum is: \"+ last_hum)});\n\nreturn msg;\n\n","outputs":1,"noerr":0,"x":290,"y":280,"wires":[["39873e10.f5f102"]]},{"id":"a3b9a326.bc16e","type":"inject","z":"75e0ac27.40ea74","name":"","topic":"","payload":"true","payloadType":"bool","repeat":"60","crontab":"","once":true,"onceDelay":"1","x":130,"y":280,"wires":[["e63f528d.87e39"]]},{"id":"5bc1ce3d.32792","type":"inject","z":"75e0ac27.40ea74","name":"","topic":"init","payload":"true","payloadType":"bool","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":130,"y":140,"wires":[["d6a9019e.4bed3"]]},{"id":"1b44d1c7.5e3d0e","type":"function","z":"75e0ac27.40ea74","name":"","func":"var tt = global.get ('time');\n\nmsg.payload = {};\nmsg.payload.temp = global.get(\"temperature[\"+(global.get('counter')-1)+\"]\");\nmsg.payload.hum = global.get(\"humidity[\"+(global.get('counter')-1)+\"]\");\n\nreturn msg;\n\n","outputs":1,"noerr":0,"x":320,"y":360,"wires":[["6a47b740.f70918","270c7749.125d78"]]},{"id":"91a057a2.b92fd8","type":"inject","z":"75e0ac27.40ea74","name":"","topic":"","payload":"","payloadType":"date","repeat":"50","crontab":"","once":true,"onceDelay":0.1,"x":170,"y":360,"wires":[["1b44d1c7.5e3d0e"]]},{"id":"5bd72da3.0c05f4","type":"ui_button","z":"75e0ac27.40ea74","name":"Sofa Light","group":"497f9af9.8562b4","order":2,"width":5,"height":1,"passthru":false,"label":"Sofa Light","tooltip":"","color":"","bgcolor":"dark","icon":"","payload":"TOGGLE","payloadType":"str","topic":"","x":130,"y":200,"wires":[["76211210.8cea4c"]]},{"id":"6a47b740.f70918","type":"ui_text","z":"75e0ac27.40ea74","group":"e9fce4c.97ada18","order":3,"width":3,"height":1,"name":"Temperature","label":"","format":"Temp: {{msg.payload.temp}} C","layout":"row-left","x":500,"y":360,"wires":[]},{"id":"39873e10.f5f102","type":"ui_chart","z":"75e0ac27.40ea74","name":"Temperature","group":"e9fce4c.97ada18","order":5,"width":0,"height":0,"label":"","chartType":"line","legend":"false","xformat":"HH:mm","interpolate":"linear","nodata":"","dot":false,"ymin":"0","ymax":"100","removeOlder":"24","removeOlderPoints":"","removeOlderUnit":"3600","cutout":0,"useOneColor":false,"colors":["#1f77b4","#ff4013","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"outputs":1,"x":490,"y":280,"wires":[[]]},{"id":"4ed3caf.564ae34","type":"Tasmota Sensor","z":"75e0ac27.40ea74","broker":"eb92f7bc.741d78","device":"Sofa_Light","name":"temp sensore","outputs":1,"fullTopic":"","cmndPrefix":"","statPrefix":"","telePrefix":"","rules":[],"x":340,"y":80,"wires":[["d6a9019e.4bed3"]]},{"id":"a2e0993f.7229c8","type":"function","z":"4aa2421.1a66cbc","name":"hum&temp","func":"msg.method = \"sendMessage\";\nvar hum = global.get(\"humidity[\"+(global.get('counter')-1)+\"]\");\nvar temp =global.get(\"temperature[\"+(global.get('counter')-1)+\"]\");\nmsg.payload = \"In House:\\n Temp: \"+ temp + \"â„ƒ \\n Humidity: \"+ hum +\"%\\n/SmartHome\";\n\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":320,"wires":[["cbff7991.e27108"]]},{"id":"196b137f.b4606d","type":"function","z":"6211decf.abf95","name":"","func":"function object_builder(){\n    var alterSwell = null;\n    var swellobject = msg.payload[0].swell;\n    var windobject = msg.payload[0];\n    var object = msg.payload[0];\n    \n    var update ={\n        date: date(object),\n        Swell: swell(swellobject),\n        Wind: wind(windobject)\n        \n    }\n    return update;\n}\n\nfunction swell(object){\n    var direction = object.components.combined.direction;\n    var period = object.components.combined.period;\n    var min = object.minBreakingHeight\n    var max = object.maxBreakingHeight;\n    var hight = object.components.combined.height;\n    if(Object.keys(object.components).length > 2){\n       alterSwell = Object.keys(object.components).length-2; \n    } \n    else{\n        alterSwell = Object.keys(object.components).length-2;\n        if (!alterSwell) alterSwell = \" No other swells\";\n    }\n    var swell={\n           Direction: direction,\n           Period: period,\n           Min: min,\n           Max: max,\n           Hight: hight,\n           AnoterSwell: alterSwell\n    }\n    return swell;\n}\n\nfunction wind(object){\n    var direction = object.wind.direction;\n    var speed = object.wind.speed;\n    var gusts = object.wind.gusts;\n    var temp = object.condition.temperature;\n    \n    var wind = {\n            Direction: direction,\n            Speed: speed,\n            Gusts: gusts,\n            Temperature: temp\n    }\n    return wind;\n}\n\nfunction date(object){\n    var issu = object.issueTimestamp;\n    var hour = new Date((msg.payload[0].localTimestamp)*1000).getHours();\n    var day = day_of_the_week(object);\n    \n    var date ={\n            Day: day,\n            Hour: hour,\n            issu: issu\n    }\n    \n    return date;\n}\nfunction day_of_the_week(object){\n    var day = new Date((msg.payload[0].localTimestamp)*1000).getDay();\n    switch (day) {\n  case 0:\n    day = \"Sunday\";\n    break;\n  case 1:\n    day = \"Monday\";\n    break;\n  case 2:\n     day = \"Tuesday\";\n    break;\n  case 3:\n    day = \"Wednesday\";\n    break;\n  case 4:\n    day = \"Thursday\";\n    break;\n  case 5:\n    day = \"Friday\";\n    break;\n  case 6:\n    day = \"Saturday\";\n}\n    return day;\n}\n\n\n\n\nmsg.payload = object_builder();\nreturn msg;\n","outputs":1,"noerr":0,"x":370,"y":280,"wires":[["3ef96479.17645c"]]},{"id":"7a213583.dba2cc","type":"delay","z":"4aa2421.1a66cbc","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":750,"y":280,"wires":[["b4531e37.d9104"]]},{"id":"bb70e7b0.ba70f8","type":"link out","z":"4aa2421.1a66cbc","name":"back to room","links":["4e949394.f4ba7c"],"x":575,"y":272,"wires":[]},{"id":"3fc591fd.e880fe","type":"link out","z":"4aa2421.1a66cbc","name":"home to room","links":["4e949394.f4ba7c"],"x":315,"y":100,"wires":[]},{"id":"4e949394.f4ba7c","type":"link in","z":"4aa2421.1a66cbc","name":"back to room in","links":["bb70e7b0.ba70f8","3fc591fd.e880fe","b6e0acec.eb877"],"x":75,"y":240,"wires":[["767e99ac.390e18"]]},{"id":"96858f1.695be7","type":"link out","z":"4aa2421.1a66cbc","name":"info to home out","links":["50240030.61ad6"],"x":495,"y":160,"wires":[]},{"id":"50240030.61ad6","type":"link in","z":"4aa2421.1a66cbc","name":"back to home in","links":["998ce581.e796e8","96858f1.695be7"],"x":80,"y":180,"wires":[["bab6ed2a.3ac4c"]]},{"id":"998ce581.e796e8","type":"link out","z":"4aa2421.1a66cbc","name":"back to home out","links":["50240030.61ad6"],"x":215,"y":360,"wires":[]},{"id":"103a33b4.152b9c","type":"link out","z":"4aa2421.1a66cbc","name":"Living room Lights out","links":["f9a10ce0.359b"],"x":455,"y":740,"wires":[]},{"id":"f9a10ce0.359b","type":"link in","z":"4aa2421.1a66cbc","name":"device in","links":["103a33b4.152b9c"],"x":295,"y":280,"wires":[["8c3efb00.fbe258"]]},{"id":"9e7e6ef0.2bcc2","type":"link in","z":"4aa2421.1a66cbc","name":"","links":["8e0dc446.08af28"],"x":655,"y":280,"wires":[["7a213583.dba2cc"]]},{"id":"31eb96ad.37a33a","type":"link in","z":"4aa2421.1a66cbc","name":"","links":["b4531e37.d9104"],"x":495,"y":81,"wires":[["f32a017b.735fb"]]},{"id":"b4531e37.d9104","type":"link out","z":"4aa2421.1a66cbc","name":"","links":["31eb96ad.37a33a"],"x":835,"y":280,"wires":[]},{"id":"cbff7991.e27108","type":"telegrambot-notify","z":"4aa2421.1a66cbc","name":"","bot":"7c410682.eb38c8","chatId":"725992047","message":"","parseMode":"","x":540,"y":320,"wires":[]},{"id":"6932d3e2.dd8cbc","type":"function","z":"4aa2421.1a66cbc","name":"room spliter","func":"if (msg.topic == \"livingRoom\") return [msg,null];\nif (msg.topic == \"kitchen\") return [null,msg];","outputs":2,"noerr":0,"x":610,"y":200,"wires":[["4d872c0e.fe9ec4"],["349a0ed8.8cd542"]]},{"id":"36484529.d533fa","type":"telegrambot-notify","z":"9cafe56.8432418","name":"","bot":"7c410682.eb38c8","chatId":"725992047","message":"","parseMode":"","x":620,"y":120,"wires":[]},{"id":"349a0ed8.8cd542","type":"link out","z":"4aa2421.1a66cbc","name":"kitchen out","links":["ef657998.17c798"],"x":735,"y":220,"wires":[]},{"id":"3ef96479.17645c","type":"function","z":"6211decf.abf95","name":"","func":"msg.payload = \"Day: \" +msg.payload.date.Day+ \", Time: \"+ msg.payload.date.Hour+\"\\nSwell: Deg: \"+msg.payload.Swell.Direction+\", Period: \"+ msg.payload.Swell.Period +\"\\n           Hight: \" +msg.payload.Swell.Hight+\", Min: \"+ msg.payload.Swell.Min +\", Max: \"+ msg.payload.Swell.Max+\"\\nWind: Deg: \"+ msg.payload.Wind.Direction+\", Speed: \"+ msg.payload.Wind.Speed+\"kn, Gusts: \"+ msg.payload.Wind.Gusts + \", Temp: \"+msg.payload.Wind.Temperature+\"C \\n/SmartHome\";\nreturn msg;","outputs":1,"noerr":0,"x":500,"y":280,"wires":[["1193fe38.cf8f42"]]},{"id":"1193fe38.cf8f42","type":"telegrambot-notify","z":"6211decf.abf95","name":"","bot":"7c410682.eb38c8","chatId":"725992047","message":"","parseMode":"","x":660,"y":280,"wires":[]},{"id":"4381f2da.937c4c","type":"link out","z":"4aa2421.1a66cbc","name":"Dromi forcast out","links":["3c5888dd.5901c8"],"x":315,"y":140,"wires":[]},{"id":"3c5888dd.5901c8","type":"link in","z":"6211decf.abf95","name":"Dromi forcast in","links":["4381f2da.937c4c"],"x":275,"y":120,"wires":[["1d7cdd19.9ff013"]]},{"id":"d98cff4c.d1e85","type":"http request","z":"c8f16773.aebe28","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"","tls":"","persist":true,"proxy":"","authType":"","x":610,"y":20,"wires":[["a3f55efa.bac64"]]},{"id":"fc419e33.2ef55","type":"http request","z":"c8f16773.aebe28","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"http://miwifi.com/cgi-bin/luci/api/xqsystem/login?username=admin&password=mia12345","tls":"","persist":true,"proxy":"","authType":"","x":150,"y":20,"wires":[["3a41883f.dfb5a8"]]},{"id":"3a41883f.dfb5a8","type":"json","z":"c8f16773.aebe28","name":"","property":"payload","action":"","pretty":false,"x":340,"y":20,"wires":[["e49be445.528698"]]},{"id":"e49be445.528698","type":"function","z":"c8f16773.aebe28","name":"","func":"var tt = msg.payload.token;\nglobal.set('WifiTok', tt);\nmsg.url = \"http://miwifi.com/cgi-bin/luci/;stok=\"+tt+\"/api/misystem/devicelist\";\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":20,"wires":[["d98cff4c.d1e85"]]},{"id":"a3f55efa.bac64","type":"json","z":"c8f16773.aebe28","name":"","property":"payload","action":"","pretty":false,"x":150,"y":80,"wires":[["6a50b65b.120e38"]]},{"id":"6a50b65b.120e38","type":"function","z":"c8f16773.aebe28","name":"","func":"var array = msg.payload.list;\nvar miamac = \"CC:46:4E:5B:AB:60\";\nvar michaelmac = \"94:E9:6A:EE:A1:86\";\nvar lihimac = \"18:65:90:85:8F:68\";\nvar mags = \"Whos home? \\n\";\nvar omags =mags;\nflow.set(['michael','mia','lihi'],[false,false,false]);\nfor (var i =0; i <array.length; i++){\n    switch (array[i].mac){\n        case (lihimac):\n            mags += \"Lihi\\n\";\n            flow.set('lihi',true);\n            break;            \n        case (michaelmac):\n            mags += \"Michael\\n\";\n            flow.set('michael',true);\n            break;\n        case (miamac):\n            mags += \"Mia\\n\";\n            flow.set('mia',true);\n            break;\n    }\n}\nif (mags === omags) mags += \"No one...ðŸ˜•\\n\";\nmags += \"Devices connected: \"+ (array.length);\nmsg.payload = mags;\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":80,"wires":[["6bd7174c.7b8448","7c5bf4b1.f1173c"]]},{"id":"c15c3212.3220c","type":"link out","z":"4aa2421.1a66cbc","name":"","links":["5498925.61df26c","434279d1.5a0dd8"],"x":215,"y":320,"wires":[]},{"id":"434279d1.5a0dd8","type":"link in","z":"c8f16773.aebe28","name":"Whos Home","links":["c15c3212.3220c"],"x":25,"y":20,"wires":[["fc419e33.2ef55"]]},{"id":"8d66a41f.63f6d8","type":"link in","z":"4aa2421.1a66cbc","name":"","links":["6bd7174c.7b8448"],"x":355,"y":360,"wires":[["cbff7991.e27108"]]},{"id":"6bd7174c.7b8448","type":"link out","z":"c8f16773.aebe28","name":"Whos Home out","links":["8d66a41f.63f6d8"],"x":355,"y":80,"wires":[]},{"id":"c395e44a.84b2c8","type":"link out","z":"c8f16773.aebe28","name":"","links":["dbf669d8.e11dd8"],"x":875,"y":640,"wires":[]},{"id":"93349677.592e28","type":"time-range-switch","z":"c8f16773.aebe28","name":"","lat":"32.44192","lon":"34.9039","startTime":"sunset","endTime":"sunrise","startOffset":0,"endOffset":0,"x":760,"y":640,"wires":[["c395e44a.84b2c8"],[]]},{"id":"96f7cf8d.1633b","type":"inject","z":"c8f16773.aebe28","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":100,"y":380,"wires":[["f94bc9f9.17d9b8"]]},{"id":"f94bc9f9.17d9b8","type":"function","z":"c8f16773.aebe28","name":"","func":"flow.set(['mia','michael','home','lihi'],[false,false,false,false]);\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":380,"wires":[[]]},{"id":"5846ad5.6b32154","type":"function","z":"c8f16773.aebe28","name":"","func":"var array = [];\nif (msg.payload.list) array = msg.payload.list;\nvar miamac = \"CC:46:4E:5B:AB:60\";\nvar michaelmac = \"94:E9:6A:EE:A1:86\";\nvar lihimac = \"18:65:90:85:8F:68\";\nvar home = flow.get(\"home\");\nvar thome = home;\nfor (var i =0; i <array.length; i++){\n    switch (array[i].mac){\n        case (michaelmac):\n            flow.set('michael',true);\n            home = true;\n            break;\n        case (lihimac):\n            flow.set('lihi',true);\n            home = true;\n            break;\n        case (miamac):\n            flow.set('mia',true);\n            home = true;\n            break;\n        default: \n            flow.set('home', false);\n            break;\n    }\n}\nflow.set('home',home);\nif(home != thome){\n        msg.payload = \"ON\";\n    return msg;\n}\nreturn null;","outputs":1,"noerr":0,"x":610,"y":640,"wires":[["93349677.592e28","bf5bf986.3c6978"]]},{"id":"4ad90b6c.e2d334","type":"inject","z":"c8f16773.aebe28","name":"","topic":"check","payload":"","payloadType":"date","repeat":"30","crontab":"","once":false,"onceDelay":0.1,"x":130,"y":440,"wires":[["910dee7f.7d51e","df092aa8.a51568"]]},{"id":"c1926b1d.dcc7c8","type":"http request","z":"c8f16773.aebe28","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"","tls":"","persist":true,"proxy":"","authType":"","x":350,"y":640,"wires":[["e98d78f.a92ec88"]]},{"id":"df092aa8.a51568","type":"function","z":"c8f16773.aebe28","name":"","func":"if (msg.topic == \"check\"){\nmsg ={}\nmsg.url = \"http://miwifi.com/cgi-bin/luci/;stok=\"+global.get('WifiTok')+\"/api/misystem/devicelist\";\nreturn msg;}","outputs":1,"noerr":0,"x":370,"y":500,"wires":[["c1926b1d.dcc7c8"]]},{"id":"16ca7a11.8b9f36","type":"inject","z":"c8f16773.aebe28","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":110,"y":140,"wires":[["fc419e33.2ef55"]]},{"id":"e98d78f.a92ec88","type":"json","z":"c8f16773.aebe28","name":"","property":"payload","action":"","pretty":false,"x":490,"y":640,"wires":[["5846ad5.6b32154","bf5bf986.3c6978"]]},{"id":"a0124170.e1af4","type":"inject","z":"c8f16773.aebe28","name":"","topic":"","payload":"","payloadType":"date","repeat":"1","crontab":"","once":false,"onceDelay":0.1,"x":490,"y":580,"wires":[["5846ad5.6b32154"]]},{"id":"910dee7f.7d51e","type":"time-range-switch","z":"c8f16773.aebe28","name":"","lat":"32.44192","lon":"34.9039","startTime":"sunset","endTime":"sunrise","startOffset":0,"endOffset":0,"x":220,"y":500,"wires":[["df092aa8.a51568"],[]]},{"id":"121d6c46.f39a54","type":"debug","z":"b61a4525.60fa38","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":660,"y":200,"wires":[]},{"id":"270c7749.125d78","type":"ui_text","z":"75e0ac27.40ea74","group":"e9fce4c.97ada18","order":3,"width":3,"height":1,"name":"humidity","label":"","format":"Hum: {{msg.payload.hum}} %","layout":"row-left","x":500,"y":400,"wires":[]},{"id":"e62ec3a6.99559","type":"function","z":"75e0ac27.40ea74","name":"Data for chart","func":"var tt = global.get ('time');\nvar i =tt.length-1;\n\n    var time = new Date(global.get(\"time[\"+i+\"]\"));\n    var temp = global.get(\"temperature[\"+i+\"]\");\n    var hum = global.get (\"humidity[\"+i+\"]\");\n    \n    time=time.toLocaleString();\nvar newline = \"Time: \"+time+ \"  ,Temp: \"+temp+\"C ,Humidity: \"+hum+\"%\";\n\nmsg.payload =newline;\n\n\nreturn msg;\n\n","outputs":1,"noerr":0,"x":320,"y":440,"wires":[[]]},{"id":"66932b4f.fd6ae4","type":"inject","z":"75e0ac27.40ea74","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":120,"y":440,"wires":[["e62ec3a6.99559"]]},{"id":"3e831b7d.3ee484","type":"Tasmota Switch","z":"f70fb094.453b4","broker":"eb92f7bc.741d78","device":"dud","name":"","outputs":"1","fullTopic":"","cmndPrefix":"","statPrefix":"","telePrefix":"","x":390,"y":220,"wires":[["6928368c.caa2e8","8df0d41f.0d33d8","89497ec5.d0ef"]]},{"id":"e6dfead.ed57318","type":"inject","z":"f70fb094.453b4","name":"","topic":"","payload":"ON","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":210,"y":500,"wires":[["3e831b7d.3ee484"]]},{"id":"215c3a24.4432c6","type":"inject","z":"f70fb094.453b4","name":"","topic":"","payload":"OFF","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":210,"y":560,"wires":[["3e831b7d.3ee484"]]},{"id":"6928368c.caa2e8","type":"function","z":"f70fb094.453b4","name":"Auto Off After 60 min","func":"var minToAutoOff = 60;\nminToAutoOff = minToAutoOff*60000;\n\n\nif (msg.payload === true){\n    global.set('dud', true);\n    msg1={reset:true}; \n    msg2={topic: \"autoOFF\",payload:\"OFF\", delay:minToAutoOff}; \n    return [[msg1,msg2]];\n} \nelse {\n    global.set('dud' , false);\n    msg1={reset:true}; \n    return msg1;\n}\n\n","outputs":1,"noerr":0,"x":600,"y":280,"wires":[["8c382f89.0bd5d"]]},{"id":"8c382f89.0bd5d","type":"delay","z":"f70fb094.453b4","name":"","pauseType":"delayv","timeout":"5","timeoutUnits":"hours","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":580,"y":340,"wires":[["4f7a2b7f.958944"]]},{"id":"7213672e.940598","type":"ui_button","z":"f70fb094.453b4","name":"","group":"115d9129.4791bf","order":3,"width":0,"height":0,"passthru":true,"label":"On (1hour)","tooltip":"","color":"","bgcolor":"","icon":"","payload":"60","payloadType":"num","topic":"set","x":90,"y":180,"wires":[["ddc8632e.465a9","8df0d41f.0d33d8"]]},{"id":"682bfb2c.996d04","type":"ui_button","z":"f70fb094.453b4","name":"","group":"115d9129.4791bf","order":2,"width":0,"height":0,"passthru":true,"label":"Off","tooltip":"","color":"","bgcolor":"","icon":"","payload":"OFF","payloadType":"str","topic":"","x":200,"y":280,"wires":[["3e831b7d.3ee484"]]},{"id":"a36eaf73.090e3","type":"ui_slider","z":"f70fb094.453b4","name":"","label":"On Timer","tooltip":"","group":"115d9129.4791bf","order":2,"width":0,"height":0,"passthru":false,"outs":"end","topic":"set","min":"0","max":"60","step":"15","x":80,"y":120,"wires":[["8df0d41f.0d33d8","87396b8e.962e88"]]},{"id":"3178a3f5.49ab9c","type":"ui_text","z":"f70fb094.453b4","group":"115d9129.4791bf","order":4,"width":0,"height":0,"name":"","label":"On Time: ","format":"{{msg.payload}}","layout":"row-left","x":600,"y":420,"wires":[]},{"id":"73cc1dc4.40e464","type":"function","z":"f70fb094.453b4","name":"","func":"\nif(global.get('dud')===true){\nvar date = new Date(null);\ndate.setMilliseconds((Date.now()-global.get('dudOnTime'))); // specify value for SECONDS here\nvar timeString = date.toISOString().substr(14, 5);\nmsg.payload = timeString +\" min\";\ncontext.set(['flag','ontime'],[1,timeString]);\nreturn msg;\n}\n\nelse if(global.get('dud')===false){\n    if (context.get('flag') == 1){\n    msg1={payload: context.get('ontime')};\n    msg.payload =\"Off\";\n    context.set('flag',0);\n    return [msg,msg1];\n    }\n    else {\n        msg.payload =\"Off\";\n        return msg;\n    }\n}\n\n","outputs":2,"noerr":0,"x":430,"y":420,"wires":[["3178a3f5.49ab9c"],["b891c364.f861a"]]},{"id":"39164af8.0c94b6","type":"inject","z":"f70fb094.453b4","name":"","topic":"time","payload":"","payloadType":"date","repeat":"1","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":420,"wires":[["73cc1dc4.40e464"]]},{"id":"ddc8632e.465a9","type":"function","z":"f70fb094.453b4","name":"Power Off after sertain time","func":"var minToAutoOff = msg.payload;\nglobal.set('dudset',msg.payload);\nminToAutoOff = minToAutoOff*60000;\nif (global.get('dud')=== false) global.set('dudOnTime', Date.now());\nglobal.set('dud' , true);\nmsg3={topic: \"dudtimer\", payload: \"ON\"};\nmsg1={reset:true}; \nmsg2={topic: \"autoOFF\",payload:\"OFF\", delay: minToAutoOff}; \nreturn [[msg1,msg2],msg3];\n\n","outputs":2,"noerr":0,"x":440,"y":140,"wires":[["4ea6b355.a32aec"],["a914137d.b3c0d"]]},{"id":"4ea6b355.a32aec","type":"delay","z":"f70fb094.453b4","name":"","pauseType":"delayv","timeout":"0","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":640,"y":101,"wires":[["a914137d.b3c0d"]]},{"id":"591cc195.8b93d","type":"link in","z":"f70fb094.453b4","name":"Dud in","links":["a914137d.b3c0d","4f7a2b7f.958944"],"x":215,"y":240,"wires":[["3e831b7d.3ee484"]]},{"id":"a914137d.b3c0d","type":"link out","z":"f70fb094.453b4","name":"Dud On","links":["591cc195.8b93d"],"x":735,"y":140,"wires":[]},{"id":"4f7a2b7f.958944","type":"link out","z":"f70fb094.453b4","name":"dud 60 min off","links":["591cc195.8b93d"],"x":675,"y":340,"wires":[]},{"id":"cdc72c57.8507b","type":"ui_text","z":"f70fb094.453b4","group":"115d9129.4791bf","order":5,"width":0,"height":0,"name":"","label":"Dud is: ","format":"{{msg.payload}}","layout":"row-left","x":620,"y":480,"wires":[]},{"id":"8df0d41f.0d33d8","type":"function","z":"f70fb094.453b4","name":"","func":"if (msg.payload === false) msg.payload = \"Off!\";\nelse if (msg.payload === true) return null;\nelse if (msg.payload === 0) return null;\nelse{\n    msg.payload =\"Set to \"+msg.payload +\" mins\";\n} \nreturn msg;","outputs":1,"noerr":0,"x":460,"y":480,"wires":[["cdc72c57.8507b"]]},{"id":"87396b8e.962e88","type":"switch","z":"f70fb094.453b4","name":"no 0","property":"payload","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"eq","v":"0","vt":"num"}],"checkall":"false","repair":false,"outputs":2,"x":230,"y":120,"wires":[["ddc8632e.465a9"],[]]},{"id":"b891c364.f861a","type":"function","z":"f70fb094.453b4","name":"","func":"var dud ={\n    name: \"dud\",\n    time: null,\n    status: null,\n    ontime: null\n}\ndud.ontime = msg.payload;\ndud.time = Date.now();\ndud.status = global.get('dud');\n\nmsg.topic = 'cvs';\nmsg = dud;\nmsg.name = \"Dud\";\n\nreturn msg;","outputs":1,"noerr":0,"x":460,"y":580,"wires":[["96d0c2d0.da83f"]]},{"id":"bcf78107.0174a","type":"debug","z":"f70fb094.453b4","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":650,"y":580,"wires":[]},{"id":"3ac8e07e.22772","type":"link in","z":"f70fb094.453b4","name":"telebot to dud on","links":["ed100a9e.23f308"],"x":275,"y":80,"wires":[["ddc8632e.465a9"]]},{"id":"e61ff2c0.5b816","type":"telegrambot-switch","z":"4aa2421.1a66cbc","name":"Dud:","bot":"7c410682.eb38c8","chatId":"725992047","question":"Dud =>","answers":["ON =>","OFF  ðŸ…¾ï¸","Status","Back"],"outputs":4,"autoAnswerCallback":true,"timeoutValue":"","timeoutUnits":"","x":250,"y":440,"wires":[["370b49d8.815f26"],["a80debf7.598158"],["1064f92a.c4f017"],["b6e0acec.eb877"]]},{"id":"370b49d8.815f26","type":"telegrambot-switch","z":"4aa2421.1a66cbc","name":"Dud:","bot":"7c410682.eb38c8","chatId":"725992047","question":"For How Long?","answers":["15 Min","30 Min","45 Min","1 Hour","Back"],"outputs":5,"autoAnswerCallback":true,"timeoutValue":"","timeoutUnits":"","x":430,"y":420,"wires":[["47127b2c.c63ef4"],["ad5821ba.d4fe9"],["d4498e7c.32fa3"],["14f876dc.bed2c9"],["e61ff2c0.5b816"]]},{"id":"47127b2c.c63ef4","type":"change","z":"4aa2421.1a66cbc","name":"15 min","rules":[{"t":"set","p":"payload","pt":"msg","to":"15","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":569,"y":382,"wires":[["ed100a9e.23f308"]]},{"id":"ad5821ba.d4fe9","type":"change","z":"4aa2421.1a66cbc","name":"30 min","rules":[{"t":"set","p":"payload","pt":"msg","to":"30","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":570,"y":420,"wires":[["ed100a9e.23f308"]]},{"id":"d4498e7c.32fa3","type":"change","z":"4aa2421.1a66cbc","name":"45 min","rules":[{"t":"set","p":"payload","pt":"msg","to":"45","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":570,"y":460,"wires":[["ed100a9e.23f308"]]},{"id":"14f876dc.bed2c9","type":"change","z":"4aa2421.1a66cbc","name":"hour","rules":[{"t":"set","p":"payload","pt":"msg","to":"60","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":570,"y":500,"wires":[["ed100a9e.23f308"]]},{"id":"b6e0acec.eb877","type":"link out","z":"4aa2421.1a66cbc","name":"dud to room","links":["4e949394.f4ba7c"],"x":355,"y":500,"wires":[]},{"id":"ed100a9e.23f308","type":"link out","z":"4aa2421.1a66cbc","name":"telebot to dud on","links":["3ac8e07e.22772"],"x":735,"y":460,"wires":[]},{"id":"5498925.61df26c","type":"link in","z":"4aa2421.1a66cbc","name":"ON/OFF dud to telebot in","links":["89497ec5.d0ef","c15c3212.3220c"],"x":255,"y":560,"wires":[["1064f92a.c4f017"]]},{"id":"1064f92a.c4f017","type":"function","z":"4aa2421.1a66cbc","name":"Dud stutus & time On","func":"msg.method = \"sendMessage\";\nvar status = global.get('dud');\nif (status === true){\n   status = \"âœ…\"; \n   var setto = global.get('dudset');\n    var timeon = (Date.now()-global.get('dudOnTime'))/60000;\n    timeon = Math.floor (timeon);\n    msg.payload = \"Dud:\\n Status: \"+ status + \"\\n Set to: \"+ setto +\"mins\\n Time On: \"+timeon+\"min \\n/SmartHome\";\n   \n} \nelse if (status === false){\n   status = \" ðŸ…¾ï¸\"; \n    var timeon1 =\"Off, was on for: \"+((global.get('dudOnTime')+(global.get('dudset')*60000))-global.get(\"dudOnTime\"))/60000;\n    //timeon1 = Math.floor (timeon1);\n    msg.payload = \"Dud:\\n Status: \"+ status + \"\\n Time On: \"+timeon1+\"min \\n/SmartHome\";\n} \n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":400,"y":580,"wires":[["43e9fcae.452264"]]},{"id":"43e9fcae.452264","type":"telegrambot-notify","z":"4aa2421.1a66cbc","name":"","bot":"7c410682.eb38c8","chatId":"725992047","message":"","parseMode":"","x":600,"y":580,"wires":[]},{"id":"a80debf7.598158","type":"change","z":"4aa2421.1a66cbc","name":"Off","rules":[{"t":"set","p":"payload","pt":"msg","to":"OFF","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":570,"y":540,"wires":[["25108e1e.bcb692"]]},{"id":"89497ec5.d0ef","type":"link out","z":"f70fb094.453b4","name":"ON/OFF dud to telebot out","links":["5498925.61df26c"],"x":495,"y":180,"wires":[]},{"id":"ac3a1d1b.50f73","type":"inject","z":"f70fb094.453b4","name":"","topic":"","payload":"dud","payloadType":"global","repeat":"1","crontab":"","once":false,"onceDelay":0.1,"x":270,"y":360,"wires":[["87da6545.ca4da8"]]},{"id":"87da6545.ca4da8","type":"ui_led","z":"f70fb094.453b4","group":"115d9129.4791bf","order":3,"width":0,"height":0,"label":"","labelPlacement":"left","labelAlignment":"left","colorForValue":[{"color":"red","value":"false","valueType":"bool"},{"color":"green","value":"true","valueType":"bool"}],"allowColorForValueInMessage":false,"name":"","x":430,"y":360,"wires":[]},{"id":"25108e1e.bcb692","type":"link out","z":"4aa2421.1a66cbc","name":"OFF telebot to dud","links":["1fdd147.6cd90ec"],"x":675,"y":540,"wires":[]},{"id":"1fdd147.6cd90ec","type":"link in","z":"f70fb094.453b4","name":"","links":["25108e1e.bcb692"],"x":115,"y":280,"wires":[["682bfb2c.996d04"]]},{"id":"7c5bf4b1.f1173c","type":"debug","z":"c8f16773.aebe28","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":520,"y":140,"wires":[]},{"id":"bf5bf986.3c6978","type":"debug","z":"c8f16773.aebe28","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":800,"y":480,"wires":[]},{"id":"e9482e54.a73d6","type":"function","z":"c2b285fa.d5e928","name":"Logger","func":"function logger (msg){\n    var name = msg.name;\n    var names = Object.getOwnPropertyNames(msg);\n    var data = dataArray(names);\n    //return createString(isfile(msg.name+\".csv\"),data);\n    //return isfile(\"tsyt.csv\",data);\n    msg1.filename = \"C:\\\\Users\\\\SmartHome\\\\Desktop\\\\Node-log\\\\\"+name+\".csv\";\n    msg2.filename = \"C:\\\\Users\\\\SmartHome\\\\Desktop\\\\Node-log\\\\\"+name+\".csv\";\n    if (isfile(name+\".csv\") === true){\n            return createString(\"value\", data);\n    }\n    else if (isfile(name+\".csv\") === false){\n                msg2.payload = createString(\"name\", data);\n                    node.send(msg2);\n                    node.done();\n            return createString(\"value\", data);\n    }\n\n    \n    \n    \n    \n    \n    \n    \n  //  var out = {\n    //  filename: data.filename = 'C:\\\\Users\\\\SmartHome\\\\Desktop\\\\Node-log\\\\' + msg.name+\".csv\",\n       // String: ???\n    \n    \n \n    \n}\n/*var logger = {\n  filename: msg.filename = 'C:\\\\Users\\\\SmartHome\\\\Desktop\\\\Node-log\\\\',\n  names: Object.getOwnPropertyNames(??????),\n  value: msg.payload\n};*/\nmsg1 = {};\nmsg2={};\nmsg1.payload=logger(msg);\nreturn msg1;\n\nfunction dataArray (obj){\n        var newl = [];\n        for (var x in obj){\n            if (obj[x]== \"_msgid\"|| obj[x] == \"topic\" || obj[x]== \"payload\" || obj[x]==\"name\" || obj[x]==\"_event\"){} \n            else{\n                \n            obj[x] ={\n                name: obj[x],\n                value: msg[obj[x]]\n            };\n            newl.push(obj[x]);\n        } \n    }\n   //flow.set([name],[newl]);\n      return newl; }\nfunction createString(valueOrname, array){\n    ///flow.set(\"tst\", array);\n    if (valueOrname == \"name\"){\n        var nameList=[];\n        for (var i in array){\n            var t = array[i].name;\n            nameList.push(t);\n        }\n        //flow.set(\"namelist\", [nameList]);\n        return nameList.join();\n    }\n    else if (valueOrname == \"value\"){\n        var valueList=[];\n        for (var z in array){\n            var a = array[z].value;\n            valueList.push(a);\n        }\n        //flow.set(\"valuelist\", [valueList]);\n        return valueList.join();\n    }\n    \n\n    \n}\nfunction isfile(name , data){\n    var list = flow.get('filelist');\n    var newlist = [];\n    for (var i in list){\n        if (name == list[i].filename){\n            flow.set('filelist['+i+'].counter', +1);\n               return true;\n            }\n        flow.set('filelist['+i+'].counter', 1);\n    }\n    \n    return false;\n}\n","outputs":1,"noerr":0,"x":800,"y":280,"wires":[["13d6c3b2.7ce26c"]]},{"id":"a25ce1e8.fbdd3","type":"function","z":"c2b285fa.d5e928","name":"tester","func":"msg= {};\nmsg.name = \"tst\";\nmsg.payload = \"1,2,3,4,5,6,6,6,6,6\";\nmsg.temp = 4;\nmsg.try = \"hello\";\nmsg.baaaa = 4.567458368;\nreturn msg;","outputs":1,"noerr":0,"x":630,"y":260,"wires":[["e9482e54.a73d6"]]},{"id":"65a5ae5d.fce2d","type":"inject","z":"c2b285fa.d5e928","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":440,"y":260,"wires":[["a25ce1e8.fbdd3"]]},{"id":"aebb54d2.d635a8","type":"function","z":"c2b285fa.d5e928","name":"creat file list","func":"function arrayandvalue (array){\n    var newarray=[];\n    for (var i in array){\n        var value = {\n            filename: array[i],\n            //value: true\n        };\n        newarray.push(value);\n    }\n    flow.set('filelist', newarray);\n}\n\narrayandvalue(msg.files);\n","outputs":0,"noerr":0,"x":770,"y":200,"wires":[]},{"id":"13d6c3b2.7ce26c","type":"file","z":"c2b285fa.d5e928","name":"","filename":"","appendNewline":true,"createDir":true,"overwriteFile":"false","encoding":"none","x":970,"y":280,"wires":[["aba7b5cb.052898"]]},{"id":"425c01ff.21345","type":"watch","z":"c2b285fa.d5e928","name":"update list on any change","files":"C:\\\\Users\\\\SmartHome\\\\Desktop\\\\Node-log\\\\","recursive":"","x":330,"y":200,"wires":[["1bb05895.59b3b7","d295fdf8.d05a4"]]},{"id":"1bb05895.59b3b7","type":"fs-ops-dir","z":"c2b285fa.d5e928","name":"","path":"C:\\\\Users\\\\SmartHome\\\\Desktop\\\\Node-log\\\\","pathType":"str","filter":"*","filterType":"str","dir":"files","dirType":"msg","x":560,"y":200,"wires":[["aebb54d2.d635a8"]]},{"id":"554fa219.f25f5c","type":"inject","z":"c2b285fa.d5e928","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":340,"y":120,"wires":[["1bb05895.59b3b7"]]},{"id":"aba7b5cb.052898","type":"debug","z":"c2b285fa.d5e928","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1130,"y":280,"wires":[]},{"id":"96d0c2d0.da83f","type":"link out","z":"f70fb094.453b4","name":"Dud to logger","links":["720c529f.8469dc"],"x":555,"y":580,"wires":[]},{"id":"720c529f.8469dc","type":"link in","z":"c2b285fa.d5e928","name":"Logger in","links":["96d0c2d0.da83f","d0dee4b9.c02d58"],"x":440,"y":340,"wires":[["e9482e54.a73d6","fe1a7635.8f0d98"]]},{"id":"fe1a7635.8f0d98","type":"debug","z":"c2b285fa.d5e928","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":660,"y":380,"wires":[]},{"id":"d0dee4b9.c02d58","type":"link out","z":"75e0ac27.40ea74","name":"HT to Logger","links":["720c529f.8469dc"],"x":655,"y":100,"wires":[]},{"id":"d295fdf8.d05a4","type":"debug","z":"c2b285fa.d5e928","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":560,"y":120,"wires":[]},{"id":"f4d20ded.3d596","type":"exec","z":"c2b285fa.d5e928","command":"shutdown /r","addpay":false,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"","x":700,"y":520,"wires":[["e4353191.421a9"],["e4353191.421a9"],["e4353191.421a9"]]},{"id":"d8740dfc.8f69d","type":"inject","z":"c2b285fa.d5e928","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":480,"y":520,"wires":[["f4d20ded.3d596"]]},{"id":"e4353191.421a9","type":"debug","z":"c2b285fa.d5e928","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1060,"y":480,"wires":[]},{"id":"daad064.ca394f8","type":"file in","z":"75e0ac27.40ea74","name":"","filename":"C:\\\\Users\\\\SmartHome\\\\Desktop\\\\Node-log\\\\htlog.csv","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":990,"y":180,"wires":[["fb390c2e.23d8","438dd554.e0f2fc"]]},{"id":"438dd554.e0f2fc","type":"debug","z":"75e0ac27.40ea74","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1370,"y":320,"wires":[]},{"id":"afbb27c3.8850b8","type":"inject","z":"75e0ac27.40ea74","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":700,"y":200,"wires":[["daad064.ca394f8"]]},{"id":"fb390c2e.23d8","type":"csv","z":"75e0ac27.40ea74","name":"","sep":",","hdrin":true,"hdrout":"","multi":"mult","ret":"\\n","temp":"time,temp,hum","skip":"0","strings":false,"x":950,"y":320,"wires":[["bd2e09d3.9ae278"]]},{"id":"bd2e09d3.9ae278","type":"function","z":"75e0ac27.40ea74","name":"","func":"arraylength = msg.payload.length;\nlastday = [];\nfor (i = arraylength; i>arraylength-1440;i--){\n    lastday.push(msg.payload[i]);\n}\nflow.set('day', lastday);","outputs":1,"noerr":0,"x":1130,"y":320,"wires":[["438dd554.e0f2fc"]]}]